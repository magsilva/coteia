USE mysql;
insert into user (host,user,password) values ('localhost','$dbuser', PASSWORD('$dbpass'));
insert into db (host,db,user,select_priv,insert_priv,update_priv,delete_priv,alter_priv) values ('localhost','$dbname','$dbuser','Y','Y','Y','Y','Y');
FLUSH PRIVILEGES;

CREATE DATABASE $dbname;

USE $dbname;

CREATE TABLE users (
	user_id int not null auto_increment,
	fullname text,
	email text,
	loginname text not null,
	pass text,
	primary key (user_id)
);

CREATE TABLE roles (
	role_id int,
	name text,
	primary key (role_id)
);

CREATE TABLE users_X_roles (
	user_id int,
	role_id int,
	FOREIGN KEY (user_id) REFERENCES users(user_id),
	FOREIGN KEY (role_id) REFERENCES roles(role_id)
);

CREATE TABLE permissions (
	permission_id int,
	description text,
	primary key (permission_id)
);

CREATE TABLE roles_X_permissions (
	role_id int,
	permission_id int,
	FOREIGN KEY (role_id) REFERENCES roles(role_id),
	FOREIGN KEY (permission_id) REFERENCES permissions(permission_id)
);

CREATE TABLE swikis (
	swiki_id int auto_increment not null,
	visible enum('S','N') default 'S',
	semester enum( '1', '2' ),
	year varchar(4),
	name text,
	responsable_id int,
	minimun_role
	create_date datetime,
	FOREIGN KEY (responsable_id) REFERENCES users(user_id),
	primary key (swiki_id)
);

CREATE TABLE wikipages (
	wikipage_id int,
	swiki_id int,
	name text,
	content text,
	create_date datetime,
	modified_date datetime,
	pass text,
	keywords text,
	author int,
	FOREIGN KEY (swiki_id) REFERENCES swikis(swiki_id),
	FOREIGN KEY (author) REFERENCES users(user_id),
	primary key (wikipage_id, name)
);

CREATE TABLE swikis_X_wikipages (
	swiki_id int,
	wikipage_id int,
  FOREIGN KEY (swiki_id) REFERENCES swikis(swiki_id),
  FOREIGN KEY (wikipage_id) REFERENCES wikipages(wikipage_id),
	primary key (id_pag, id_sw)
);


insert into admin values (NULL, 'admin' , '$ADMIN_MAIL' ,'admin', MD5('$ADMIN_PASSWORD'));
